#!/usr/bin/env python3

import sys
import bluetooth
import SonyHeadphonesControl as SHC

addr = None
mode = None

if len(sys.argv) < 3:
    print("Invalid arguments, please specify BT address and desired mode")
    sys.exit(0)
else:
    addr = sys.argv[1]
    mode = sys.argv[2]
    print("Searching for {}...".format(addr))

uuid = "96cc203e-5068-46ad-b32d-e316f5e069ba"
service_matches = bluetooth.find_service(uuid=uuid, address=addr)

if len(service_matches) == 0:
    print("Couldn't find the device service.")
    sys.exit(0)

first_match = service_matches[0]
port = first_match["port"]
host = str(first_match["host"], 'utf-8')

ambientSoundBytes = None

if mode == 'noise-cancelling':
    # Noise cancelling ?
    ambientSoundBytes = SHC.getAmbientSound(True, 2, 0, False)

elif mode == 'wind-cancelling':
    # Wind cancelling ?
    ambientSoundBytes = SHC.getAmbientSound(True, 1, 0, False)

elif mode == 'ambient-sound':
    # Ambient sound
    ambientSoundBytes = SHC.getAmbientSound(True, 0, 19, False)

elif mode == 'disable':
    # Disabled ambient sound SHC
    ambientSoundBytes = SHC.getAmbientSound(False, 0, 0, False)

else:
    print('Unknown mode, exiting')
    sys.exit(0)

print("Connecting to {} to enable {}".format(host, mode))

# Create the client socket
sock = bluetooth.BluetoothSocket(bluetooth.RFCOMM)
sock.connect((host, port))

# print('ambientSoundBytes', ambientSoundBytes)
packetBytes = SHC.getPacket(ambientSoundBytes)
# print('packetBytes', packetBytes)
packetCrcBytes = SHC.getCrcPacket(packetBytes)
# print('packetCrcBytes', packetCrcBytes)
result = bytes(packetCrcBytes)
# print('result', result)

sock.send(result)
sock.close()
